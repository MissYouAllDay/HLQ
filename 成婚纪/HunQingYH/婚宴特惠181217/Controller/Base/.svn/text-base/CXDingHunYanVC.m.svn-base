//
//  YPHunYanTeHuiBaseController.m
//  HunQingYH
//
//  Created by Elseä¸¶ on 2018/12/17.
//  Copyright Â© 2018 YanpengLee. All rights reserved.
//

#import "CXDingHunYanVC.h"
#import "YPBanquetListObj.h"
#pragma mark - Cell

#import "YPHYTHBaseListCell.h"
//#import "YPHYTHThreeSelectView.h"
#import "YPHYTHNoDataCell.h"
#import "JXCategoryTitleView.h" // segment
#import "JXCategoryIndicatorLineView.h" //segmentçš„xæ»‘å—
#import "YPHomeQueryTingController.h"  //  å®´ä¼šå…æœç´¢

#pragma mark - VC
#import "YPHYTHDetailController.h"//è¯¦æƒ…
#import "YPHYTHOrderBaseController.h"//è®¢å•
#import "YPHYTHSearchViewController.h"//æœç´¢
#import "YPContractController.h"//è”ç³»æˆ‘ä»¬
#pragma mark - Model
#import "YPGetPreferentialCommodityList.h"

#pragma mark - third
#import "FSCustomButton.h"
#import "CJAreaPicker.h"//åœ°å€é€‰æ‹©
#import "BRDatePickerView.h"
#import "CXSearchYHTView.h" // æŸ¥æ‰¾å®´ä¼šå…
#import "FL_Button.h"

@interface CXDingHunYanVC ()<UITableViewDelegate,UITableViewDataSource,CJAreaPickerDelegate,JXCategoryViewDelegate>

@property (nonatomic, strong) UITableView *tableView;
@property (nonatomic, strong) UIImageView *topImg;
@property (nonatomic, strong) UIView *sectionHeadView;
@property (nonatomic, strong) JXCategoryTitleView *segmentView;
@property (nonatomic, strong) CXSearchYHTView *searchView;

@property (nonatomic, strong) UIControl *control;
@property (nonatomic, strong) NSMutableArray<YPBanquetListObj *> *listMarr;
@property (nonatomic, strong) NSArray *segmentData; // æ ‡é¢˜æ•°æ®

/***********************************åœ°å€é€‰æ‹©*****************************************/
/**ç»çº¬åº¦åæ ‡*/
@property (strong, nonatomic) NSString *coordinates;
/**ç¼“å­˜åŸå¸‚*/
@property (strong, nonatomic) NSString *cityInfo;
/**ç¼“å­˜åŸå¸‚parentid*/
@property (assign, nonatomic) NSInteger parentID;
/**åœ°åŒºID*/
@property (strong, nonatomic) NSString *areaid;
/***********************************åœ°å€é€‰æ‹©*****************************************/
/** ç­›é€‰å®´ä¼šå…ã€‚ æ—¥æœŸ */
@property (nonatomic, copy) NSString *tingDateStr;
/** ç­›é€‰yhå®´ä¼šå…ã€‚æ¡Œæ•° */
@property (nonatomic, copy) NSString *tingZhuoShu;
@end

@implementation CXDingHunYanVC{
    UIView *_navView;
    
    FSCustomButton *_monthBtn;
    NSString *_month;
    UIButton *_searchBtn;
    
    //æ•°æ®åº“
    FMDatabase *dataBase;
    NSInteger _pageIndex;
    
    NSString *_SortField;//0æ­£åº,1å€’åº
    NSString *_Sort;//0é”€é‡,1ä»·æ ¼
}

#pragma mark - éšè—å¯¼èˆªæ¡
- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    
    [self.navigationController setNavigationBarHidden:YES animated:NO];
    
    [self GetPreferentialCommodityList];
    if (!UserId_New) {
        [self.navigationController.tabBarController setSelectedIndex:0];
        
    }
}

- (void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    
    [self.navigationController setNavigationBarHidden:NO animated:NO];
}

#pragma mark - UI
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.automaticallyAdjustsScrollViewInsets = NO;
    self.view.backgroundColor = WhiteColor;
    
    NSDate *date = [NSDate date];
    NSDateFormatter *matter = [[NSDateFormatter alloc] init];
    matter.dateFormat = @"yyyyå¹´MMæœˆddæ—¥";
    self.tingDateStr = [matter stringFromDate:date];
    self.tingZhuoShu = @"1 æ¡Œ";
    
    _pageIndex = 1;
    _month = [NSString stringWithFormat:@"%02ld",(long)date.month];
    
    [self setupNav];
    
}

#pragma mark - UI
- (void)setupNav{
    
    NSDate *date = [NSDate date];
    
    _navView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, ScreenWidth, NAVIGATION_BAR_HEIGHT)];
    _navView.backgroundColor = WhiteColor;
    [self.view addSubview:_navView];
    
    
    if (!_searchBtn) {
        _searchBtn  = [UIButton buttonWithType:UIButtonTypeCustom];
    }
    [_searchBtn setTitle:@"  è¾“å…¥é…’åº—/å®´ä¼šå…åç§°" forState:UIControlStateNormal];
    [_searchBtn setTitleColor:RGBS(199) forState:UIControlStateNormal];
    _searchBtn.titleLabel.font = [UIFont fontWithName:@"PingFangSC-Regular" size: 13];
    [_searchBtn setImage:[UIImage imageNamed:@"search_gray"] forState:UIControlStateNormal];
    _searchBtn.backgroundColor = RGBS(248);
    _searchBtn.layer.cornerRadius = 4;
    _searchBtn.clipsToBounds = YES;
    [_searchBtn addTarget:self action:@selector(searchBtnClick) forControlEvents:UIControlEventTouchUpInside];
    [_navView addSubview:_searchBtn];
    [_searchBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.size.mas_equalTo(CGSizeMake(ScreenWidth*0.65-18, 32));
        make.right.mas_equalTo(-18);
        make.bottom.mas_equalTo(_navView.mas_bottom).offset(-10);
    }];
    
    if (!_monthBtn) {
        _monthBtn  = [[FSCustomButton alloc]init];
    }
    
    _monthBtn.buttonImagePosition = FSCustomButtonImagePositionRight;
    [_monthBtn setImage:[UIImage imageNamed:@"home_loc"] forState:UIControlStateNormal];
    [_monthBtn setTitleColor:BlackColor forState:UIControlStateNormal];
    if (! [self checkCityInfo]) {
        [_monthBtn setTitle:@"é’å²›å¸‚" forState:UIControlStateNormal];
        self.cityInfo = @"é’å²›å¸‚";
        self.parentID = 171;
    }else{
        [_monthBtn setTitle:self.cityInfo forState:UIControlStateNormal];
    }

        [_monthBtn addTarget:self action:@selector(cityBtnClick) forControlEvents:UIControlEventTouchUpInside];
        _monthBtn.layer.cornerRadius = 4;
        _monthBtn.clipsToBounds = YES;
        [_navView addSubview:_monthBtn];
        [_monthBtn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.width.mas_equalTo(ScreenWidth*0.35-18-12);
            make.left.mas_equalTo(18);
            make.centerY.mas_equalTo(_searchBtn);
            make.height.mas_equalTo(32);
        }];
    
    [self selectDataBase];
    [self searchCityList:nil withParentId:[self.areaid integerValue]];
}

- (void)setupUI{
    self.view.backgroundColor = WhiteColor;
    
    if (!self.tableView) {
        self.tableView = [[UITableView alloc]initWithFrame:CGRectMake(0, NAVIGATION_BAR_HEIGHT, ScreenWidth, ScreenHeight-NAVIGATION_BAR_HEIGHT-TAB_BAR_HEIGHT) style:UITableViewStylePlain];
    }
    self.tableView.delegate = self;
    self.tableView.dataSource = self;
    self.tableView.backgroundColor = WhiteColor;
    self.tableView.estimatedRowHeight = 0;
    self.tableView.estimatedSectionFooterHeight = 0;
    self.tableView.estimatedSectionHeaderHeight = 0;
    self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.tableView.tableFooterView = [[UIView alloc]init];
    self.tableView.tableHeaderView = self.topImg;
    [self.view addSubview:self.tableView];
    
    self.tableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        _pageIndex = 1;
        [self GetPreferentialCommodityList];
    }];
    self.tableView.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
        _pageIndex ++;
        [self GetPreferentialCommodityList];
    }];
}

#pragma mark - UITableViewDataSource
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 1;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
  
    return self.listMarr.count == 0 ? 1 : self.listMarr.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    if (self.listMarr.count == 0) {
        YPHYTHNoDataCell *cell = [YPHYTHNoDataCell cellWithTableView:tableView];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        [cell.doneBtn addTarget:self action:@selector(ruzhuBtnClick) forControlEvents:UIControlEventTouchUpInside];
        return cell;
    }else{
        YPBanquetListObj *list = self.listMarr[indexPath.row];
        
        YPHYTHBaseListCell *cell = [YPHYTHBaseListCell cellWithTableView:tableView];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        [cell.imgV sd_setImageWithURL:[NSURL URLWithString:list.HotelLogo] placeholderImage:[UIImage imageNamed:@"å›¾ç‰‡å ä½"]];
        [cell.iconImgV sd_setImageWithURL:[NSURL URLWithString:list.HeadImg] placeholderImage:[UIImage imageNamed:@"å›¾ç‰‡å ä½"]];
        if (list.BanquetHallName.length > 0) {
            cell.tingTitle.text = list.BanquetHallName;
        }else{
            cell.tingTitle.text = @"å½“å‰æ— åç§°";
        }
        if (list.Name.length > 0) {
            cell.titleLabel.text = list.Name;
        }else{
            cell.titleLabel.text = @"å½“å‰æ— åç§°";
        }
        cell.canbiao.text = list.FloorPrice;
        cell.zhuoshu.text = [NSString stringWithFormat:@"%ld-%ld",list.MinTableNumber,list.MaxTableCount];
        cell.lijian.text = [NSString stringWithFormat:@"%@%%",list.Discount];
        cell.countLabel.text = [NSString stringWithFormat:@"%@",list.ReservedQuantity];
        return cell;
    }
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return self.listMarr.count == 0 ? 450 : ScreenWidth*0.78;//366
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return 0.1;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
   
    return Line375(200);
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
 
    return self.sectionHeadView;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    YPBanquetListObj *list = self.listMarr[indexPath.row];
    
    YPHYTHDetailController *detail = [[YPHYTHDetailController alloc]init];
    detail.detailID = list.BanquetID;
    [self.navigationController pushViewController:detail animated:YES];
}

#pragma mark - å¯¼èˆªæ  target
- (void)monthBtnClick{
    NSLog(@"monthBtnClick");
    NSDate *date = [NSDate date];
    
    [BRDatePickerView showDatePickerWithTitle:@"é€‰æ‹©å©šå®´æ—¥æœŸ" dateType:BRDatePickerModeYM defaultSelValue:[NSString stringWithFormat:@"%zd-%@",date.year,_month] minDate:date maxDate:nil isAutoSelect:YES themeColor:nil resultBlock:^(NSString *selectValue) {
        NSArray *arr = [selectValue componentsSeparatedByString:@"-"];
        //        [_monthBtn setTitle:[NSString stringWithFormat:@"å©šå®´ç‰¹æƒ Â·%@æœˆ",arr[1]] forState:UIControlStateNormal];
        
        NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:[NSString stringWithFormat:@"å©šå®´ç‰¹æƒ   %@æœˆ",arr[1]]];
        [attr addAttribute:NSFontAttributeName value:[UIFont systemFontOfSize:13.0] range:NSMakeRange(0, 6)];
        [attr addAttribute:NSFontAttributeName value:[UIFont fontWithName:@"PingFangSC-Semibold" size: 16] range:NSMakeRange(6, 3)];
        [_monthBtn setAttributedTitle:attr forState:UIControlStateNormal];
        
        _month = [NSString stringWithFormat:@"%@",arr[1]];
        
        _pageIndex = 1;//é‡ç½®
        [self GetPreferentialCommodityList];
    }];
}

- (void)searchBtnClick{
    NSLog(@"searchBtnClick");
    YPHYTHSearchViewController *search = [[YPHYTHSearchViewController alloc]init];
    [self.navigationController pushViewController:search animated:YES];
}

- (void)ruzhuBtnClick{
    //è”ç³»æˆ‘ä»¬
    YPContractController *contract = [[YPContractController alloc]init];
    [self.navigationController presentViewController:contract animated:YES completion:nil];
}

#pragma mark - - - - - - - - - - - - - - - ç½‘ç»œè¯·æ±‚ - - - - - - - - - - - - - - - - -
#pragma mark è·å–ç‰¹æƒ å•†å“åˆ—è¡¨
- (void)GetPreferentialCommodityList{
    
    [EasyShowLodingView showLoding];
    
    NSString *url = @"/api/HQOAApi/GetAllBanquetHallList";
    
    NSMutableDictionary *params = [NSMutableDictionary dictionary];
    params[@"AreaId"] = self.areaid;
    //    params[@"Name"] = @"";
    params[@"PageIndex"] = [NSString stringWithFormat:@"%zd",_pageIndex];
    params[@"PageCount"] = @"10";
    //    params[@"Mouth"] = _month;
    params[@"SortField"] = _SortField;//0æ­£åº,1å€’åº
    params[@"Sort"] = _Sort;//0é”€é‡,1ä»·æ ¼
    //    params[@"FacilitatorId"] = @"";//19-02-22 æ·»åŠ  ä¾›åº”å•†ä¸»é¡µä½¿ç”¨
    
    [[NetworkTool shareManager] requestWithUrlStr:url withParams:params Success:^(NSDictionary *object) {
        
        // èŠèŠ±ä¸ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œéœ€è¦è‡ªå·±ç§»é™¤
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [EasyShowLodingView hidenLoding];
        });
        
        if ([[[object valueForKey:@"Message"] valueForKey:@"Code"] integerValue] == 200) {
            
            if (_pageIndex == 1) {
                
                [self.listMarr removeAllObjects];
                self.listMarr = [YPBanquetListObj mj_objectArrayWithKeyValuesArray:[object objectForKey:@"Data"]];
                
            }else{
                NSArray *newArray = [YPBanquetListObj mj_objectArrayWithKeyValuesArray:[object objectForKey:@"Data"]];
                
                if (newArray.count == 0) {
                    self.tableView.mj_footer.state = MJRefreshStateNoMoreData;
                }else{
                    [self.listMarr addObjectsFromArray:newArray];
                }
                
            }
            
            [self.tableView reloadData];
            [self endRefresh];
            
        }else{
            
            [EasyShowTextView showText:[[object valueForKey:@"Message"] valueForKey:@"Inform"] ];
        }
        
    } Failure:^(NSError *error) {
        // èŠèŠ±ä¸ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œéœ€è¦è‡ªå·±ç§»é™¤
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [EasyShowLodingView hidenLoding];
        });
        
        [self showNetErrorEmptyView];
        
    }];
    
}

/**
 *  åœæ­¢åˆ·æ–°
 */
-(void)endRefresh{
    [self.tableView.mj_header endRefreshing];
    [self.tableView.mj_footer endRefreshing];
}

#pragma mark - ç¼ºçœ
-(void)showNoDataEmptyView{
    
    [EasyShowEmptyView showEmptyViewWithTitle:@"è¯¥åŒºåŸŸæš‚æ— å•†å®¶å…¥é©»\nå¿«æ¥æŠ¢å å…ˆæœº" subTitle:@"" imageName:@"HYTH_nodata.png" inview:self.tableView callback:^(EasyShowEmptyView *view, UIButton *button, callbackType callbackType) {
        [self GetPreferentialCommodityList];
    }];
    
}
-(void)showNetErrorEmptyView{
    
    [EasyShowEmptyView showEmptyViewWithTitle:@"ç½‘ç»œé”™è¯¯" subTitle:@"ç‚¹å‡»é‡æ–°åŠ è½½æ•°æ®ï¼" imageName:@"netError.png" inview:self.tableView callback:^(EasyShowEmptyView *view, UIButton *button, callbackType callbackType) {
        [self GetPreferentialCommodityList];
    }];
    
}
-(void)hidenEmptyView{
    [ EasyShowEmptyView hiddenEmptyView:self.view];
}

#pragma mark - getter
- (NSString *)areaid{
    if (!_areaid) {
        self.areaid = [[NSUserDefaults standardUserDefaults]objectForKey:@"city_id_new"];
    }
    return _areaid;
}

- (NSString *)cityInfo{
    if (!_cityInfo) {
        self.cityInfo =  [[NSUserDefaults standardUserDefaults]objectForKey:@"city_name_new"];
    }
    return _cityInfo;
}

- (NSMutableArray<YPBanquetListObj *> *)listMarr{
    if (!_listMarr) {
        _listMarr = [NSMutableArray array];
    }
    return _listMarr;
}

- (UIImageView *)topImg {
    
    if (!_topImg) {
        _topImg = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0, ScreenWidth,  ScreenWidth*0.67)];
        [_topImg sd_setImageWithURL:[NSURL URLWithString: @"http://121.42.156.151:96/2/1/100000/2/3/795f83c0-66c2-42bc-8d61-abff1c52626c.jpg"] placeholderImage:[UIImage imageNamed:@"å›¾ç‰‡å ä½"]];
    }
    return _topImg;
}

- (UIView *)sectionHeadView {
    
    if (!_sectionHeadView) {
        _sectionHeadView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, ScreenWidth, Line375(200))];
        _sectionHeadView.backgroundColor = [UIColor whiteColor];
        
        UIView *line = [[UIView alloc] initWithFrame:CGRectMake(16, self.segmentView.height, ScreenWidth - 32, 1)];
        line.backgroundColor = [UIColor colorWithHexString:@"#F5F5F5"];
        
        CXSearchYHTView *searchView = [[[NSBundle mainBundle] loadNibNamed:@"CXSearchYHTView" owner:nil options:nil] lastObject];
        searchView.frame = CGRectMake(0, line.bottom, ScreenWidth, Line375(160));
        [searchView.dateBtn addTarget:self action:@selector(tingDateBtnClick) forControlEvents:UIControlEventTouchUpInside];
        [searchView.zhuoshuBtn addTarget:self action:@selector(tingZhuoshuBtnClick) forControlEvents:UIControlEventTouchUpInside];
        [searchView.zhuoshuBtn addTarget:self action:@selector(tingZhuoshuBtnClick) forControlEvents:UIControlEventTouchUpInside];
        [searchView.lookBtn addTarget:self action:@selector(queryHotelLookBtnClick) forControlEvents:UIControlEventTouchUpInside];

        [searchView.dateBtn setTitle:self.tingDateStr forState:UIControlStateNormal];
        [searchView.zhuoshuBtn setTitle:self.tingZhuoShu forState:UIControlStateNormal];
        self.searchView = searchView;
        
        JXCategoryIndicatorLineView *lineView = [[JXCategoryIndicatorLineView alloc] init];
        lineView.indicatorLineViewColor = [UIColor redColor];
        lineView.indicatorLineWidth = 30;
        self.segmentView.indicators = @[lineView];
        
        [_sectionHeadView addSubview:self.segmentView];
        [_sectionHeadView addSubview:line];
        [_sectionHeadView addSubview:searchView];
    }
    return _sectionHeadView;
}

- (JXCategoryTitleView *)segmentView {
    
    if (!_segmentView) {
        
        _segmentView = [[JXCategoryTitleView alloc]initWithFrame:CGRectMake(0, 0, [UIScreen mainScreen].bounds.size.width, Line375(40))];
        _segmentView.titles = self.segmentData;
        _segmentView.delegate = self;
        _segmentView.titleColorGradientEnabled = YES;
        _segmentView.titleSelectedColor = [UIColor redColor];
        _segmentView.titleLabelStrokeWidthEnabled = YES;
    }
    return _segmentView;
}

- (void)categoryView:(JXCategoryBaseView *)categoryView didSelectedItemAtIndex:(NSInteger)index {
    
    if (index == 0) {
        self.areaid = [NSString stringWithFormat:@"%ld",self.parentID];
        [self GetPreferentialCommodityList];
    }else {
        self.cityInfo = self.segmentData[index];
        [self selectDataBase];
        [self GetPreferentialCommodityList];
    }
}

#pragma mark - - - - - - - - - - - - - - - æŸ¥è¯¢å®´ä¼šå… - - - - - - - - - - - - - - - - -
- (void)tingDateBtnClick{
    [BRDatePickerView showDatePickerWithTitle:@"è¯·é€‰æ‹©æ—¶é—´" dateType:BRDatePickerModeDate defaultSelValue:@"" minDate:[NSDate date] maxDate:nil isAutoSelect:NO themeColor:nil resultBlock:^(NSString *selectValue) {
        NSArray *arr = [selectValue componentsSeparatedByString:@"-"];
        self.tingDateStr = [NSString stringWithFormat:@"%@å¹´%@æœˆ%@æ—¥",arr[0],arr[1],arr[2]];
        [self.searchView.dateBtn setTitle:self.tingDateStr forState:UIControlStateNormal];
    }];
}

- (void)tingZhuoshuBtnClick{
    UIAlertView *alert = [[UIAlertView alloc]initWithTitle:@"æ¡Œæ•°" message:nil delegate:self cancelButtonTitle:@"å–æ¶ˆ" otherButtonTitles:@"ç¡®å®š", nil];
    [alert setAlertViewStyle:UIAlertViewStylePlainTextInput];
    UITextField *txtName = [alert textFieldAtIndex:0];
    txtName.keyboardType = UIKeyboardTypeNumberPad;
    txtName.placeholder = @"è¯·è¾“å…¥æ¡Œæ•°";
    [alert show];
}

#pragma mark - UIAlertViewDelegate
- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    if (buttonIndex == 1) {
        UITextField *tf = [alertView textFieldAtIndex:0];
        self.tingZhuoShu = [NSString stringWithFormat:@"%@æ¡Œ",tf.text];
        [self.searchView.zhuoshuBtn setTitle:self.tingZhuoShu forState:UIControlStateNormal];
    }
}

- (void)queryHotelLookBtnClick{
    YPHomeQueryTingController *ting = [[YPHomeQueryTingController alloc]init];
    ting.dateStr = self.tingDateStr;
    ting.zhuoShu = self.tingZhuoShu;
    [self.navigationController pushViewController:ting animated:YES];
}


#pragma mark - - - - - - - - - - - - - - - é€‰æ‹©åŸå¸‚ - - - - - - - - - - - - - - - - -
-(void)cityBtnClick{
    CJAreaPicker *picker = [[CJAreaPicker alloc]initWithStyle:UITableViewStylePlain];
    picker.delegate = self;
    picker.endType = CJPlaceEndCity;
    //    picker.userlocation = self.currentLocation;
    UINavigationController *navc = [[UINavigationController alloc]initWithRootViewController:picker];
    [self presentViewController:navc animated:YES completion:nil];
}

#pragma mark - CJAreaPickerDelegate
- (void)areaPicker:(CJAreaPicker *)picker didSelectAddress:(NSString *)address parentID:(NSInteger)parentID{
    
    self.parentID = parentID;
    NSLog(@"ç¼“å­˜åŸå¸‚è®¾ç½®ä¸º%@",address);
    self.cityInfo = address;
    
    [self dismissViewControllerAnimated:YES completion:nil];
    
    //  æŸ¥è¯¢address çš„ areaIdx
    [self selectDataBase];
    
    [self searchCityList:nil withParentId:parentID];
    
    _pageIndex = 1;//é‡ç½®
    [_monthBtn setTitle:address forState:UIControlStateNormal];
    [self GetPreferentialCommodityList];
    
}

#pragma mark --------æ•°æ®åº“-------
-(void)moveToDBFile
{       //1ã€è·å¾—æ•°æ®åº“æ–‡ä»¶åœ¨å·¥ç¨‹ä¸­çš„è·¯å¾„â€”â€”æºè·¯å¾„ã€‚
    NSString *sourcesPath = [[NSBundle mainBundle] pathForResource:@"region"ofType:@"db"];
    
    NSLog(@"sourcesPath %@",sourcesPath);
    //2ã€è·å¾—æ²™ç›’ä¸­Documentæ–‡ä»¶å¤¹çš„è·¯å¾„â€”â€”ç›®çš„è·¯å¾„
    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
    NSString *documentPath = [paths objectAtIndex:0];
    NSLog(@"documentPath %@",documentPath);
    
    NSString *desPath = [documentPath stringByAppendingPathComponent:@"region.db"];
    //3ã€é€šè¿‡NSFileManagerç±»ï¼Œå°†å·¥ç¨‹ä¸­çš„æ•°æ®åº“æ–‡ä»¶å¤åˆ¶åˆ°æ²™ç›’ä¸­ã€‚
    NSFileManager *fileManager = [NSFileManager defaultManager];
    if (![fileManager fileExistsAtPath:desPath])
    {
        NSError *error ;
        if ([fileManager copyItemAtPath:sourcesPath toPath:desPath error:&error]) {
            NSLog(@"æ•°æ®åº“ç§»åŠ¨æˆåŠŸ");
        }
        else {
            NSLog(@"æ•°æ®åº“ç§»åŠ¨å¤±è´¥");
        }
    }
    
}
//æ‰“å¼€æ•°æ®åº“
- (void)openDataBase{
    NSArray *filePath = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
    NSString *documentPath = [filePath objectAtIndex:0];
    NSString *dbFilePath = [documentPath stringByAppendingPathComponent:@"region.db"];
    
    dataBase =[[FMDatabase alloc]initWithPath:dbFilePath];
    BOOL ret = [dataBase open];
    if (ret) {
        NSLog(@"æ‰“å¼€æ•°æ®åº“æˆåŠŸ");
        
    }else{
        NSLog(@"æ‰“å¼€æ•°æ®åº“æˆåŠŸ");
    }
    
}
//å…³é—­æ•°æ®åº“
- (void)closeDataBase{
    BOOL ret = [dataBase close];
    if (ret) {
        NSLog(@"å…³é—­æ•°æ®åº“æˆåŠŸ");
    }else{
        NSLog(@"å…³é—­æ•°æ®åº“å¤±è´¥");
    }
}
//æŸ¥è¯¢æ•°æ®åº“
-(void)selectDataBase{
    [self openDataBase];
    NSString *huanCun = [[NSUserDefaults standardUserDefaults]objectForKey:@"city_name_new"];
    NSLog(@"ç¼“å­˜åŸå¸‚ä¸º%@",huanCun);
    NSLog(@"_cityInfo*$#$#$##$$%@",self.cityInfo);
    NSString *selectSql =[NSString stringWithFormat:@"SELECT REGION_ID FROM Region WHERE REGION_NAME ='%@'",self.cityInfo];
    FMResultSet *set =[dataBase executeQuery:selectSql];
    while ([set next]) {
        int ID = [set intForColumn:@"REGION_ID"];
        NSLog(@"==*****%d",ID);
        NSString *idStr = [NSString stringWithFormat:@"%d",ID];
        
        //6-5
        //        [[NSUserDefaults standardUserDefaults]setObject:idStr forKey:@"areaid"];
        //        NSLog(@"areaid ------- %@",[[NSUserDefaults standardUserDefaults] objectForKey:@"areaid"]);
        self.areaid =idStr;
    }
    [self closeDataBase];
    
    [self.tableView reloadData];
    NSLog(@"~~~~~~ huanCun:%@ cityInfo:%@ areaid:%@ ",huanCun,self.cityInfo,self.areaid);
    
}
/**  æ˜¯å¦æœ‰åŸå¸‚ç¼“å­˜ */
-(BOOL)checkCityInfo{
    if ([[[NSUserDefaults standardUserDefaults]objectForKey:@"city_name_new"] isEqualToString:@""]||![[NSUserDefaults standardUserDefaults]objectForKey:@"city_name_new"] ) {
        //å¦‚æœä¸å­˜åœ¨åŸå¸‚ç¼“å­˜
        return NO;
    }else{
        return YES;
    }
    
}

/**
 æŸ¥è¯¢æŸå¸‚çº§æ‰€ç®¡è¾–çš„å¿/åŒº
 */
- (void)searchCityList:(NSString *)selectCity withParentId:(NSInteger )parentID {
    
    [self openDataBase];
    NSMutableArray *areaArray = [[NSMutableArray alloc] init];

    NSString *selectSql4 =[NSString stringWithFormat:@"SELECT REGION_NAME FROM Region WHERE  PARENT_ID = %ld",parentID];
    FMResultSet *set4 =[dataBase executeQuery:selectSql4];
 
    while ([set4 next]) {
        NSString *cityStr  = [set4 stringForColumn:@"REGION_NAME"];
        [areaArray addObject:cityStr];
        
    }
    [self closeDataBase];
    [areaArray insertObject:@"å…¨éƒ¨åŒºåŸŸ" atIndex:0];
    [self.sectionHeadView removeFromSuperview];
    self.sectionHeadView = nil;
    self.segmentView = nil;
    self.segmentData = areaArray;

    [self setupUI];
    [self.tableView reloadData];
}
@end
